syntax = "proto3";

package manman.v1;

option go_package = "github.com/whale-net/everything/manman/protos;manmanpb";

// ============================================================================
// Structured Data Types
// ============================================================================

// PortBinding represents a container-to-host port mapping
message PortBinding {
  int32 container_port = 1;
  int32 host_port = 2;
  string protocol = 3;  // "TCP" | "UDP"
}

// FileTemplate represents a file to be created in the container
message FileTemplate {
  string path = 1;
  string content = 2;
  string mode = 3;  // e.g., "0644"
  bool is_template = 4;
}

// Parameter represents a configurable parameter for a game
message Parameter {
  string key = 1;
  string value = 2;
  string type = 3;  // "string" | "int" | "bool" | "secret"
  string description = 4;
  bool required = 5;
  string default_value = 6;
}

// GameMetadata represents additional information about a game
message GameMetadata {
  string genre = 1;
  string publisher = 2;
  int32 default_players = 3;
  int32 max_players = 4;
  map<string, string> links = 5;
  repeated string tags = 6;
}

// ServerCapabilities represents the resources available on a server
message ServerCapabilities {
  int32 total_memory_mb = 1;
  int32 available_memory_mb = 2;
  int32 cpu_cores = 3;
  int32 available_cpu_millicores = 4;
  repeated PortRange available_ports = 5;
  string docker_version = 6;
}

// PortRange represents a range of available ports
message PortRange {
  int32 start = 1;
  int32 end = 2;
  string protocol = 3;
}

// LogBatch represents a compressed batch of logs
message LogBatch {
  string batch_id = 1;  // UUID for deduplication
  int64 session_id = 2;
  int64 start_timestamp = 3;
  int64 end_timestamp = 4;
  int32 line_count = 5;
  bytes compressed_logs = 6;
  LogSource source = 7;
}

// LogSource indicates where logs originated from
enum LogSource {
  LOG_SOURCE_UNSPECIFIED = 0;
  LOG_SOURCE_STDOUT = 1;
  LOG_SOURCE_STDERR = 2;
  LOG_SOURCE_WRAPPER = 3;
}

// ============================================================================
// Domain Models
// ============================================================================

// Server represents a physical/virtual machine running the host manager
message Server {
  int64 server_id = 1;
  string name = 2;
  string status = 3;  // "online" | "offline"
  int64 last_seen = 4;  // Unix timestamp (seconds since epoch), 0 if never seen
}

// Game represents a game definition (e.g., Minecraft, Valheim)
message Game {
  int64 game_id = 1;
  string name = 2;
  string steam_app_id = 3;  // optional
  GameMetadata metadata = 4;
}

// GameConfig represents a preset/template for running a game
message GameConfig {
  int64 config_id = 1;
  int64 game_id = 2;
  string name = 3;
  string image = 4;
  string args_template = 5;  // optional
  map<string, string> env_template = 6;
  repeated FileTemplate files = 7;
  repeated Parameter parameters = 8;
}

// ServerGameConfig represents a game configuration deployed on a specific server
message ServerGameConfig {
  int64 server_game_config_id = 1;
  int64 server_id = 2;
  int64 game_config_id = 3;
  repeated PortBinding port_bindings = 4;
  map<string, string> parameters = 5;
  string status = 6;  // "active" | "inactive"
}

// Session represents an execution of a ServerGameConfig
message Session {
  int64 session_id = 1;
  int64 server_game_config_id = 2;
  int64 started_at = 3;  // Unix timestamp, 0 if not started
  int64 ended_at = 4;  // Unix timestamp, 0 if not ended
  int32 exit_code = 5;
  string status = 6;  // "pending" | "starting" | "running" | "stopping" | "stopped" | "crashed" | "completed"
  map<string, string> parameters = 7;
}

// ServerPort represents port allocation tracking at server level
message ServerPort {
  int64 server_id = 1;
  int32 port = 2;
  string protocol = 3;  // "TCP" | "UDP"
  int64 server_game_config_id = 4;  // 0 if not allocated
  int64 allocated_at = 5;  // Unix timestamp
}
