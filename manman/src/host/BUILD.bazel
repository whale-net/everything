load("@rules_python//python:defs.bzl", "py_binary", "py_library", "py_test")

# Export files for subdirectories
exports_files([
    "main.py",
    "experience_api_test.py",
    "status_api_test.py",
    "worker_dal_api_test.py",
])

# Host main entry point and CLI
py_library(
    name = "host_main",
    srcs = [
        "__init__.py",
        "main.py",
        "openapi.py",
    ],
    visibility = ["//manman/src/host:__subpackages__"],
    deps = [
        ":status_processor_lib",
        "//libs/python/alembic",
        "//libs/python/cli:params",
        "//libs/python/cli:types",
        "//libs/python/cli/providers/app_env",
        "//libs/python/cli/providers/postgres",
        "//libs/python/cli/providers/rabbitmq",
        "//libs/python/gunicorn",  # Gunicorn config utilities
        "//libs/python/logging",  # Use consolidated logging
        "//manman/src:manman_core",
        "//manman/src/host/api:api_shared",
        "//manman/src/host/api/experience:experience_api_lib",
        "//manman/src/host/api/status:status_api_lib",
        "//manman/src/host/api/worker_dal:worker_dal_api_lib",
        "//manman/src/migrations:manman_migrations",
        "//manman/src/repository:manman_repository",
        "@pypi//:alembic",
        "@pypi//:fastapi",
        "@pypi//:gunicorn",
        "@pypi//:typer",
        "@pypi//:uvicorn",
    ],
)

# Status processor library
py_library(
    name = "status_processor_lib",
    srcs = [
        "status_processor.py",
    ],
    visibility = ["//manman/src/host:__subpackages__"],
    deps = [
        "//manman/src:manman_core",
        "//manman/src/repository:manman_repository",
        "@pypi//:python-jose",
        "@pypi//:requests",
    ],
)

# Status processor binary
py_binary(
    name = "status_processor",
    srcs = ["main.py"],
    args = ["start-status-processor"],
    main = "main.py",
    visibility = ["//manman:__pkg__"],
    deps = [":host_main"],
)

# Status processor test
py_test(
    name = "status_processor_test",
    size = "small",
    srcs = ["status_processor_test.py"],
    main = "status_processor_test.py",
    deps = [
        ":host_main",
        ":status_processor_lib",
        "@pypi//:pytest",
        "@pypi//:pytest-asyncio",
    ],
)

# Migration binaries
py_binary(
    name = "migration",
    srcs = ["main.py"],
    args = ["run-migration"],
    main = "main.py",
    visibility = ["//manman:__pkg__"],
    deps = [":host_main"],
)

py_binary(
    name = "migration_cli",
    srcs = ["main.py"],
    main = "main.py",
    visibility = ["//manman:__pkg__"],
    deps = [":host_main"],
)

# Legacy compatibility: Combined library for all host services
py_library(
    name = "manman_host",
    visibility = [
        "//libs/python/openapi_gen:__pkg__",
        "//manman:__subpackages__",
    ],
    deps = [
        ":host_main",
        ":status_processor_lib",
        "//manman/src/host/api:api_shared",
        "//manman/src/host/api/experience:experience_api_lib",
        "//manman/src/host/api/status:status_api_lib",
        "//manman/src/host/api/worker_dal:worker_dal_api_lib",
    ],
)

# Aliases for binary targets (for backward compatibility)
alias(
    name = "experience_api",
    actual = "//manman/src/host/api/experience:experience_api",
    visibility = ["//manman:__pkg__"],
)

alias(
    name = "status_api",
    actual = "//manman/src/host/api/status:status_api",
    visibility = ["//manman:__pkg__"],
)

alias(
    name = "worker_dal_api",
    actual = "//manman/src/host/api/worker_dal:worker_dal_api",
    visibility = ["//manman:__pkg__"],
)

# Note: Release app definitions, OpenAPI specs, and API clients are in //manman:BUILD.bazel
