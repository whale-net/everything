name: Update uv.lock

on:
  workflow_dispatch:
  # Can also be triggered on push to pyproject.toml
  # push:
  #   paths:
  #     - 'pyproject.toml'

jobs:
  update-lock:
    name: Update uv.lock
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        
    - name: Update lock file
      run: |
        uv lock --python 3.11
        
    - name: Check for changes
      id: check
      run: |
        if git diff --quiet uv.lock; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes to uv.lock"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Changes detected in uv.lock"
        fi
        
    - name: Create Pull Request
      if: steps.check.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Update uv.lock with latest dependencies
        title: 'chore: Update uv.lock'
        body: |
          ## Automated uv.lock Update
          
          This PR updates `uv.lock` to match the dependencies specified in `pyproject.toml`.
          
          ### Changes
          - Updated lock file after dependency changes in `pyproject.toml`
          
          ### Verification
          Please verify:
          - [ ] All tests pass: `bazel test //...`
          - [ ] Coverage collection works: `bazel coverage //demo/hello_python:test_main`
          
          Auto-generated by `update-lock.yml` workflow.
        branch: update-uv-lock
        delete-branch: true
        labels: dependencies
        
    - name: No changes detected
      if: steps.check.outputs.changed == 'false'
      run: |
        echo "âœ… uv.lock is already up to date with pyproject.toml"
