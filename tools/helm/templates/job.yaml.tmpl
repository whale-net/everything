{{- range $appName, $app := .Values.apps }}
{{- if eq $app.type "job" }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ $appName }}-{{ $.Values.global.environment }}
  namespace: {{ $.Values.global.namespace }}
  labels:
    app: {{ $appName }}-{{ $.Values.global.environment }}
    component: job
  annotations:
    # Jobs run before deployments in ArgoCD sync phases
    "argocd.argoproj.io/sync-wave": "-1"
    # Hook annotation for Helm-managed lifecycle
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: {{ $app.jobBackoffLimit | default 3 }}
  {{- if $app.jobTTLSecondsAfterFinished }}
  ttlSecondsAfterFinished: {{ $app.jobTTLSecondsAfterFinished }}
  {{- end }}
  template:
    metadata:
      namespace: {{ $.Values.global.namespace }}
      labels:
        app: {{ $appName }}-{{ $.Values.global.environment }}
        component: job
    spec:
      restartPolicy: {{ $app.jobRestartPolicy | default "OnFailure" }}
      containers:
        - name: {{ $appName }}
          image: "{{ $app.image }}:{{ $app.imageTag }}"
          resources:
            requests:
              cpu: {{ $app.resources.requests.cpu }}
              memory: {{ $app.resources.requests.memory }}
            limits:
              cpu: {{ $app.resources.limits.cpu }}
              memory: {{ $app.resources.limits.memory }}
          {{- if $app.command }}
          command:
            {{- range $app.command }}
            - {{ . }}
            {{- end }}
          {{- end }}
          {{- if $app.args }}
          args:
            {{- range $app.args }}
            - {{ . }}
            {{- end }}
          {{- end }}
          env:
            # Application metadata (from release_app + Helm)
            - name: APP_NAME
              value: {{ $appName | quote }}
            - name: APP_DOMAIN
              value: {{ $app.domain | default $.Values.global.domain | quote }}
            - name: APP_TYPE
              value: {{ $app.type | quote }}
            - name: APP_VERSION
              value: {{ $app.imageTag | quote }}
            - name: APP_ENV
              value: {{ $.Values.global.environment | quote }}
            - name: ENVIRONMENT
              value: {{ $.Values.global.environment | quote }}
            {{- if $app.commitSha }}
            - name: GIT_COMMIT
              value: {{ $app.commitSha | quote }}
            - name: COMMIT_SHA
              value: {{ $app.commitSha | quote }}
            {{- end }}
            
            # Kubernetes context (downward API)
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: CONTAINER_NAME
              value: {{ $appName | quote }}
            - name: HOSTNAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            
            # Helm context
            - name: HELM_CHART_NAME
              value: {{ $.Chart.Name | quote }}
            - name: HELM_RELEASE_NAME
              value: {{ $.Release.Name | quote }}
            
            # OpenTelemetry configuration
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ $.Values.otlp.endpoint | default "http://otel-collector:4317" | quote }}
            - name: OTEL_SERVICE_NAME
              value: {{ $appName | quote }}
            
            {{- if $app.env }}
            # Additional app-specific environment variables
            {{- range $key, $value := $app.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
            {{- end }}
{{- end }}
{{- end }}
