{{- range $appName, $app := .Values.apps }}
{{- if or (eq $app.type "external-api") (eq $app.type "internal-api") (eq $app.type "worker") }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $appName }}-{{ $.Values.global.environment }}
  namespace: {{ $.Values.global.namespace }}
  labels:
    app: {{ $appName }}-{{ $.Values.global.environment }}
    component: {{ $app.type }}
  annotations:
    # Ensure this deploys after migrations complete
    "argocd.argoproj.io/sync-wave": "0"
spec:
  replicas: {{ $app.replicas }}
  selector:
    matchLabels:
      app: {{ $appName }}-{{ $.Values.global.environment }}
  template:
    metadata:
      namespace: {{ $.Values.global.namespace }}
      labels:
        app: {{ $appName }}-{{ $.Values.global.environment }}
        component: {{ $app.type }}
    spec:
      containers:
        - name: {{ $appName }}
          image: "{{ $app.image }}:{{ $app.imageTag }}"
          resources:
            requests:
              cpu: {{ $app.resources.requests.cpu }}
              memory: {{ $app.resources.requests.memory }}
            limits:
              cpu: {{ $app.resources.limits.cpu }}
              memory: {{ $app.resources.limits.memory }}
          {{- if or (eq $app.type "external-api") (eq $app.type "internal-api") }}
          ports:
            - containerPort: {{ $app.port }}
              name: http
          {{- end }}
          {{- if $app.command }}
          command:
            {{- range $app.command }}
            - {{ . }}
            {{- end }}
          {{- end }}
          {{- if $app.args }}
          args:
            {{- range $app.args }}
            - {{ . }}
            {{- end }}
          {{- end }}
          {{- if and $app.healthCheck (or (eq $app.type "external-api") (eq $app.type "internal-api")) }}
          livenessProbe:
            httpGet:
              path: {{ $app.healthCheck.path }}
              port: {{ default $app.port $app.healthCheck.port }}
            initialDelaySeconds: {{ $app.healthCheck.initialDelaySeconds }}
            periodSeconds: {{ $app.healthCheck.periodSeconds }}
            timeoutSeconds: {{ $app.healthCheck.timeoutSeconds }}
            failureThreshold: {{ $app.healthCheck.failureThreshold }}
          readinessProbe:
            httpGet:
              path: {{ $app.healthCheck.path }}
              port: {{ default $app.port $app.healthCheck.port }}
            initialDelaySeconds: {{ $app.healthCheck.initialDelaySeconds }}
            periodSeconds: {{ $app.healthCheck.periodSeconds }}
            timeoutSeconds: {{ $app.healthCheck.timeoutSeconds }}
            failureThreshold: {{ $app.healthCheck.failureThreshold }}
          {{- else if and $app.healthCheck (eq $app.type "worker") }}
          {{- /* Workers may have health endpoints but on a different port */ -}}
          livenessProbe:
            httpGet:
              path: {{ $app.healthCheck.path }}
              port: {{ default 8000 $app.healthCheck.port }}
            initialDelaySeconds: {{ $app.healthCheck.initialDelaySeconds }}
            periodSeconds: {{ default 20 $app.healthCheck.periodSeconds }}
          readinessProbe:
            httpGet:
              path: {{ $app.healthCheck.path }}
              port: {{ default 8000 $app.healthCheck.port }}
            initialDelaySeconds: {{ $app.healthCheck.initialDelaySeconds }}
            periodSeconds: {{ $app.healthCheck.periodSeconds }}
            timeoutSeconds: {{ $app.healthCheck.timeoutSeconds }}
            failureThreshold: {{ $app.healthCheck.failureThreshold }}
          {{- end }}
          {{- if $app.env }}
          env:
            {{- range $key, $value := $app.env }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
          {{- end }}
{{- end }}
{{- end }}
