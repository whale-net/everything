{{- if .Values.ingress.enabled -}}
{{- range $appName, $app := .Values.apps }}
{{- if eq $app.type "external-api" }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $appName }}-{{ $.Values.global.environment }}-ingress
  namespace: {{ $.Values.global.namespace }}
  labels:
    app: {{ $appName }}
    environment: {{ $.Values.global.environment }}
    chart: {{ $.Chart.Name }}
  annotations:
    # Ingress deploys with services and deployments
    "argocd.argoproj.io/sync-wave": "0"
  {{- with $.Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if $.Values.ingress.className }}
  ingressClassName: {{ $.Values.ingress.className }}
  {{- end }}
  {{- if or $.Values.ingress.tls (and $app.ingress $app.ingress.tlsSecretName) }}
  tls:
    {{- if and $app.ingress $app.ingress.tlsSecretName }}
    - secretName: {{ $app.ingress.tlsSecretName }}
      hosts:
        - {{ $app.ingress.host | default (printf "%s-%s.local" $appName $.Values.global.environment) }}
    {{- end }}
    {{- range $.Values.ingress.tls }}
    - secretName: {{ .secretName }}
      {{- if .hosts }}
      hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ if $app.ingress }}{{ $app.ingress.host | default (printf "%s-%s.local" $appName $.Values.global.environment) }}{{ else }}{{ printf "%s-%s.local" $appName $.Values.global.environment }}{{ end }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $appName }}-{{ $.Values.global.environment }}-service
                port:
                  number: {{ $app.port | default 8000 }}
{{- end }}
{{- end }}
{{- end }}
