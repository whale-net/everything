{{- if .Values.ingressDefaults.enabled -}}
{{- range $appName, $app := .Values.apps }}
{{- if or (eq $app.type "external-api") (and (eq $app.type "internal-api") $app.exposeIngress) }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $appName }}-{{ $.Values.global.environment }}-ingress
  namespace: {{ $.Values.global.namespace }}
  labels:
    app: {{ $appName }}
    environment: {{ $.Values.global.environment }}
    chart: {{ $.Chart.Name }}
  annotations:
    # Ingress deploys with services and deployments
    "argocd.argoproj.io/sync-wave": "0"
  {{- with $.Values.ingressDefaults.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if $.Values.ingressDefaults.className }}
  ingressClassName: {{ $.Values.ingressDefaults.className }}
  {{- end }}
  {{- if and $app.ingress $app.ingress.tlsSecretName }}
  tls:
    - secretName: {{ $app.ingress.tlsSecretName }}-{{ $.Values.global.environment }}
      hosts:
        - {{ $app.ingress.host | default (printf "%s-%s.local" $appName $.Values.global.environment) }}
  {{- end }}
  rules:
    - host: {{ if $app.ingress }}{{ $app.ingress.host | default (printf "%s-%s.local" $appName $.Values.global.environment) }}{{ else }}{{ printf "%s-%s.local" $appName $.Values.global.environment }}{{ end }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ $appName }}-{{ $.Values.global.environment }}-service
                port:
                  number: {{ $app.port | default 8000 }}
{{- end }}
{{- end }}
{{- end }}
