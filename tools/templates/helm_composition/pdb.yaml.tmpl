{{/*
Pod Disruption Budget template for multi-app deployments
Generates PDBs for apps with multiple replicas to ensure availability
*/}}
{{- $domain := .Values.domain }}
{{- range $appName, $appConfig := index .Values $domain "apps" }}
{{- if and $appConfig.enabled (gt ($appConfig.replicas | int) 1) }}
{{- $appContext := dict "Values" $.Values "Chart" $.Chart "Release" $.Release "appName" $appName }}
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "multiapp.fullname" $appContext }}
  labels:
    {{- include "multiapp.appLabels" $appContext | nindent 4 }}
spec:
  {{- if $appConfig.pdb }}
  {{- if $appConfig.pdb.minAvailable }}
  minAvailable: {{ $appConfig.pdb.minAvailable }}
  {{- else if $appConfig.pdb.maxUnavailable }}
  maxUnavailable: {{ $appConfig.pdb.maxUnavailable }}
  {{- else }}
  minAvailable: 1
  {{- end }}
  {{- else }}
  minAvailable: 1
  {{- end }}
  selector:
    matchLabels:
      {{- include "multiapp.selectorLabels" $appContext | nindent 6 }}
{{- end }}
{{- end }}