tasks:
  setup-python:
    name: Setup Python venv
    description: Create Python virtual environment with uv and sync dependencies. Also symlinks python3 to /usr/bin for Bazel sandbox compatibility.
    command: |
      # Bazel sandbox uses /usr/bin/env python3 but the devcontainer feature
      # installs Python to /usr/local/python/current/bin. Create a symlink.
      if [ ! -e /usr/bin/python3 ] && [ -e /usr/local/python/current/bin/python3 ]; then
        sudo ln -sf /usr/local/python/current/bin/python3 /usr/bin/python3
      fi

      uv venv
      source .venv/bin/activate
      uv sync
    triggeredBy:
      - postDevcontainerStart

  setup-k3d:
    name: Create k3d cluster
    description: Create a local k3d Kubernetes cluster for Tilt development.
    command: |
      if k3d cluster list 2>/dev/null | grep -q "everything"; then
        echo "k3d cluster 'everything' already exists"
      else
        k3d cluster create everything --wait
      fi

      # dev-util Helm charts expect a "hostpath" StorageClass.
      # k3d only ships "local-path", so create an alias.
      if ! kubectl get storageclass hostpath >/dev/null 2>&1; then
        kubectl apply -f - <<'EOF'
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: hostpath
      provisioner: rancher.io/local-path
      reclaimPolicy: Delete
      volumeBindingMode: WaitForFirstConsumer
      EOF
      fi
    triggeredBy:
      - postDevcontainerStart
