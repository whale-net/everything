{{define "session_detail_content"}}
<div class="action-bar">
    <h1>Session {{.Session.SessionId}}</h1>
    <div>
        <a href="/sessions" class="btn btn-secondary btn-sm">Back to Sessions</a>
        {{if eq .Session.Status "running"}}
        <form hx-post="/sessions/{{.Session.SessionId}}/stop" hx-target="body" style="display: inline;">
            <button type="submit" class="btn btn-danger btn-sm">Stop Session</button>
        </form>
        {{end}}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-title">Session Details</div>
    </div>
    <dl style="display: grid; grid-template-columns: 200px 1fr; gap: 0.5rem;">
        <dt><strong>Session ID:</strong></dt>
        <dd>{{.Session.SessionId}}</dd>

        <dt><strong>Status:</strong></dt>
        <dd><span class="badge {{statusBadge .Session.Status}}">{{.Session.Status}}</span></dd>

        <dt><strong>Available:</strong></dt>
        <dd>
            {{if eq .Session.Status "running"}}
            <span class="badge badge-success">Yes (Ready for connections)</span>
            {{else if or (eq .Session.Status "starting") (eq .Session.Status "pending")}}
            <span class="badge badge-warning">Starting (Wait for it to be ready)</span>
            {{else}}
            <span class="badge badge-danger">No (Server is not running)</span>
            {{end}}
        </dd>

        {{if .Game}}
        <dt><strong>Game:</strong></dt>
        <dd><a href="/games/{{.Game.GameId}}">{{.Game.Name}}</a></dd>
        {{end}}

        {{if .GameConfig}}
        <dt><strong>GameConfig:</strong></dt>
        <dd><a href="/games/{{.Game.GameId}}/configs/{{.GameConfig.ConfigId}}">{{.GameConfig.Name}}</a> <small style="color: #666;">({{.GameConfig.Image}})</small></dd>
        {{end}}

        <dt><strong>Server Game Config:</strong></dt>
        <dd>
            <a href="/sgc/{{.Session.ServerGameConfigId}}">SGC #{{.Session.ServerGameConfigId}}</a>
            {{if .SGC}}<small style="color: #666;">(Server #{{.SGC.ServerId}})</small>{{end}}
        </dd>

        <dt><strong>Started:</strong></dt>
        <dd>{{timeAgo .Session.StartedAt}} ({{formatTime .Session.StartedAt}})</dd>

        <dt><strong>Ended:</strong></dt>
        <dd>{{timeAgo .Session.EndedAt}} ({{formatTime .Session.EndedAt}})</dd>

        <dt><strong>Exit Code:</strong></dt>
        <dd>{{.Session.ExitCode}}</dd>
    </dl>
</div>

<!-- Workshop Addons Card -->
<div class="card">
    <div class="card-header">
        <div class="card-title">Workshop Addons</div>
    </div>
    {{if eq (len .Libraries) 0}}
    <div class="empty-state" style="padding: 1rem;">
        <p>No libraries configured for this SGC. <a href="/sgc/{{.Session.ServerGameConfigId}}">Manage SGC</a> to add libraries.</p>
    </div>
    {{else if eq (len .Installations) 0}}
    <div class="empty-state" style="padding: 1rem;">
        <p>Libraries attached but no addons installed yet.</p>
    </div>
    {{else}}
    {{if or (eq .Session.Status "pending") (eq .Session.Status "starting")}}
    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 0.75rem; margin-bottom: 1rem; color: #856404;">
        Installing addons before launch...
    </div>
    {{end}}
    <table>
        <thead>
            <tr>
                <th>Addon ID</th>
                <th>Status</th>
                <th>Progress</th>
                <th>Path</th>
            </tr>
        </thead>
        <tbody>
            {{range .Installations}}
            <tr>
                <td>{{.AddonId}}</td>
                <td><span class="badge {{statusBadge .Status}}">{{.Status}}</span></td>
                <td>
                    {{if eq .Status "downloading"}}
                    {{.ProgressPercent}}%
                    {{else}}
                    —
                    {{end}}
                </td>
                <td><code style="font-size: 0.75rem;">{{.InstallationPath}}</code></td>
            </tr>
            {{end}}
        </tbody>
    </table>
    {{end}}
</div>

<script>
// Shared log line rendering used by both live and historical views.
function appendLogLine(container, timestamp, source, message) {
    const line = document.createElement('span');
    line.className = 'log-line log-' + source;
    line.textContent = '[' + timestamp + '] [' + source + '] ' + message;
    container.appendChild(line);
    container.appendChild(document.createTextNode('\n'));
}

function parseAndAppendRawLine(container, lineText) {
    if (!lineText.trim()) return;
    const match = lineText.match(/\[([^\]]+)\] \[([^\]]+)\] (.+)/);
    if (match) {
        appendLogLine(container, match[1], match[2], match[3]);
    } else {
        const line = document.createElement('span');
        line.className = 'log-line';
        line.textContent = lineText;
        container.appendChild(line);
        container.appendChild(document.createTextNode('\n'));
    }
}
</script>

{{if eq .Session.Status "running"}}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="card-title">Live Logs</div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button id="toggle-logs" class="btn btn-sm btn-secondary">Hide</button>
            <button id="clear-logs" class="btn btn-sm btn-secondary">Clear</button>
            <span id="log-status" style="font-size: 0.85rem; color: #888;">Connecting...</span>
        </div>
    </div>
    <div id="log-viewer" class="log-viewer">
        <pre id="log-output" class="log-output"></pre>
    </div>
    <div class="stdin-input">
        <form id="stdin-form" style="display: flex; gap: 0.5rem; padding: 0.75rem; background: #2d2d2d; border-top: 1px solid #3e3e3e;">
            <input type="text" id="stdin-input" placeholder="Send command to server..." style="flex: 1; padding: 0.5rem; background: #1e1e1e; border: 1px solid #3e3e3e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; border-radius: 4px;">
            <button type="submit" id="stdin-submit" class="btn btn-sm btn-primary" style="min-width: 80px;">Send</button>
        </form>
        <div id="stdin-status" style="padding: 0 0.75rem 0.5rem; font-size: 0.75rem; color: #888; min-height: 1.25rem;"></div>
    </div>
</div>

{{if .Actions}}
<div class="card">
    <div class="card-header">
        <div class="card-title">Quick Actions</div>
    </div>
    <div style="padding: 1rem;">
        <div id="action-status" style="margin-bottom: 1rem;"></div>

        {{range .Actions}}
        <div class="action-item" style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e0e0e0;">
            {{if .GroupName}}
            <h4 style="margin-top: 0; margin-bottom: 0.75rem; font-size: 0.9rem; color: #666; text-transform: uppercase;">{{.GroupName}}</h4>
            {{end}}

            {{if .Description}}
            <p style="margin: 0 0 0.75rem; color: #666; font-size: 0.9rem;">{{.Description}}</p>
            {{end}}

            {{if eq (len .InputFields) 0}}
            <!-- Simple button (no inputs) -->
            <button class="btn btn-{{.ButtonStyle}}"
                    hx-post="/sessions/{{$.Session.SessionId}}/actions/execute"
                    hx-vals='{"action_id": "{{.ActionId}}"}'
                    hx-target="#action-status"
                    hx-swap="innerHTML"
                    {{if .RequiresConfirmation}}
                    hx-confirm="{{.ConfirmationMessage}}"
                    {{end}}>
                {{if .Icon}}<i class="{{.Icon}}"></i> {{end}}{{.Label}}
            </button>

            {{else}}
            <!-- Parameterized button (with inputs) -->
            <form hx-post="/sessions/{{$.Session.SessionId}}/actions/execute"
                  hx-target="#action-status"
                  hx-swap="innerHTML"
                  style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 500px;">
                <input type="hidden" name="action_id" value="{{.ActionId}}">

                {{range .InputFields}}
                <div class="form-group" style="margin: 0;">
                    <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">
                        {{.Label}}{{if .Required}}<span style="color: red;">*</span>{{end}}
                    </label>

                    {{if eq .FieldType "select"}}
                    <select name="{{.Name}}"
                            {{if .Required}}required{{end}}
                            style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                        {{range .Options}}
                        <option value="{{.Value}}" {{if .IsDefault}}selected{{end}}>
                            {{.Label}}
                        </option>
                        {{end}}
                    </select>

                    {{else if eq .FieldType "textarea"}}
                    <textarea name="{{.Name}}"
                              placeholder="{{.Placeholder}}"
                              {{if .Required}}required{{end}}
                              style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; min-height: 80px;"></textarea>

                    {{else if eq .FieldType "number"}}
                    <input type="number"
                           name="{{.Name}}"
                           placeholder="{{.Placeholder}}"
                           {{if .Required}}required{{end}}
                           {{if ne .MinValue 0.0}}min="{{.MinValue}}"{{end}}
                           {{if ne .MaxValue 0.0}}max="{{.MaxValue}}"{{end}}
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">

                    {{else}}
                    <input type="{{.FieldType}}"
                           name="{{.Name}}"
                           placeholder="{{.Placeholder}}"
                           {{if .Required}}required{{end}}
                           {{if .Pattern}}pattern="{{.Pattern}}"{{end}}
                           {{if ne .MinLength 0}}minlength="{{.MinLength}}"{{end}}
                           {{if ne .MaxLength 0}}maxlength="{{.MaxLength}}"{{end}}
                           style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    {{end}}

                    {{if .HelpText}}
                    <small style="display: block; margin-top: 0.25rem; color: #666;">{{.HelpText}}</small>
                    {{end}}
                </div>
                {{end}}

                <button type="submit" class="btn btn-{{.ButtonStyle}}"
                        {{if .RequiresConfirmation}}
                        hx-confirm="{{.ConfirmationMessage}}"
                        {{end}}>
                    {{if .Icon}}<i class="{{.Icon}}"></i> {{end}}{{.Label}}
                </button>
            </form>
            {{end}}
        </div>
        {{end}}
    </div>
</div>
{{end}}

<style>
.log-viewer {
    background: #1e1e1e;
    border-radius: 4px;
    max-height: 600px;
    overflow: hidden;
    display: block;
}
.log-output {
    margin: 0;
    padding: 1rem;
    color: #d4d4d4;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    overflow-y: auto;
    max-height: 600px;
    white-space: pre-wrap;
    word-wrap: break-word;
}
.log-line {
    display: block;
}
.log-stdout {
    color: #d4d4d4;
}
.log-stderr {
    color: #f48771;
}
.log-host {
    color: #4fc1ff;
}
.log-viewer.collapsed .log-output {
    display: none;
}
</style>

<script>
(function() {
    const logOutput = document.getElementById('log-output');
    const logStatus = document.getElementById('log-status');
    const logViewer = document.getElementById('log-viewer');
    const toggleBtn = document.getElementById('toggle-logs');
    const clearBtn = document.getElementById('clear-logs');

    let autoScroll = true;
    let evtSource = null;

    function connect() {
        evtSource = new EventSource('/sessions/{{.Session.SessionId}}/logs/stream');

        evtSource.onopen = () => {
            logStatus.textContent = '● Connected';
            logStatus.style.color = '#4fc1ff';
        };

        evtSource.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'connected') return;

            // Format timestamp and append log line
            const date = new Date(data.timestamp);
            const time = date.toLocaleTimeString('en-US', { hour12: false });
            appendLogLine(logOutput, time, data.source, data.message);

            // Auto-scroll to bottom if enabled
            if (autoScroll) {
                logOutput.scrollTop = logOutput.scrollHeight;
            }

            // Limit to last 1000 lines (prevent memory bloat)
            const lines = logOutput.children;
            if (lines.length > 1000) {
                logOutput.removeChild(lines[0]);
            }
        };

        evtSource.onerror = () => {
            logStatus.textContent = '● Disconnected';
            logStatus.style.color = '#f48771';
            evtSource.close();
            setTimeout(connect, 2000);  // Auto-reconnect after 2s
        };
    }

    toggleBtn.onclick = () => {
        logViewer.classList.toggle('collapsed');
        toggleBtn.textContent = logViewer.classList.contains('collapsed') ? 'Show' : 'Hide';
    };

    clearBtn.onclick = () => {
        logOutput.textContent = '';
    };

    // Detect manual scroll (disable auto-scroll)
    logOutput.onscroll = () => {
        const atBottom = logOutput.scrollHeight - logOutput.clientHeight <= logOutput.scrollTop + 50;
        autoScroll = atBottom;
    };

    // Start streaming
    connect();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (evtSource) evtSource.close();
    });

    // Handle stdin input
    const stdinForm = document.getElementById('stdin-form');
    const stdinInput = document.getElementById('stdin-input');
    const stdinSubmit = document.getElementById('stdin-submit');
    const stdinStatus = document.getElementById('stdin-status');

    stdinForm.onsubmit = async (e) => {
        e.preventDefault();
        const input = stdinInput.value;
        if (!input.trim()) return;

        // Disable input while processing
        stdinInput.disabled = true;
        stdinSubmit.disabled = true;
        stdinStatus.textContent = 'Sending...';
        stdinStatus.style.color = '#4fc1ff';

        try {
            const response = await fetch('/api/sessions/{{.Session.SessionId}}/stdin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input: input }),
                signal: AbortSignal.timeout(10000)  // 10s timeout
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            // Clear input on success
            stdinInput.value = '';
            stdinStatus.textContent = '✓ Sent';
            stdinStatus.style.color = '#4fc1ff';
            setTimeout(() => { stdinStatus.textContent = ''; }, 2000);
        } catch (err) {
            stdinStatus.textContent = `✗ Error: ${err.message}`;
            stdinStatus.style.color = '#f48771';
        } finally {
            stdinInput.disabled = false;
            stdinSubmit.disabled = false;
            stdinInput.focus();
        }
    };
})();
</script>
{{else}}
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="card-title">Historical Logs</div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button id="load-historical" class="btn btn-sm btn-primary">Load Logs</button>
            <button id="download-historical" class="btn btn-sm btn-secondary" style="display: none;">Download</button>
            <button id="clear-historical" class="btn btn-sm btn-secondary">Clear</button>
        </div>
    </div>
    <div style="padding: 1rem;">
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-end;">
            <div>
                <label for="center-time" style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Time UTC (±10 minutes):</label>
                <input type="datetime-local" id="center-time" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.875rem;">
            </div>
            <div style="font-size: 0.875rem; color: #666; padding-bottom: 0.5rem;">
                Enter time in UTC. Loads logs from 10 minutes before to 10 minutes after.
            </div>
        </div>
        <div id="historical-status" style="font-size: 0.875rem; color: #888; margin-bottom: 1rem;"></div>
    </div>
    <div id="historical-log-viewer" class="log-viewer" style="display: none;">
        <pre id="historical-log-output" class="log-output"></pre>
    </div>
</div>

<script>
(function() {
    const loadBtn = document.getElementById('load-historical');
    const downloadBtn = document.getElementById('download-historical');
    const clearBtn = document.getElementById('clear-historical');
    const centerTimeInput = document.getElementById('center-time');
    const statusDiv = document.getElementById('historical-status');
    const logViewer = document.getElementById('historical-log-viewer');
    const logOutput = document.getElementById('historical-log-output');

    let currentLogData = null; // Store current log data for download

    // Set default time to session end time
    {{if .Session.EndedAt}}
    const centerTime = new Date({{.Session.EndedAt}} * 1000);
    centerTimeInput.value = centerTime.toISOString().slice(0, 16);
    {{end}}

    loadBtn.onclick = async () => {
        // Parse as UTC (datetime-local gives us a string like "2026-02-10T04:09")
        const centerStr = centerTimeInput.value;
        if (!centerStr) {
            statusDiv.textContent = 'Please select a valid time';
            statusDiv.style.color = '#f48771';
            return;
        }

        // Create UTC date by appending 'Z' to force UTC interpretation
        const center = new Date(centerStr + 'Z');
        if (isNaN(center.getTime())) {
            statusDiv.textContent = 'Please select a valid time';
            statusDiv.style.color = '#f48771';
            return;
        }

        // Calculate ±10 minutes
        const start = new Date(center.getTime() - (10 * 60 * 1000));  // 10 minutes before
        const end = new Date(center.getTime() + (10 * 60 * 1000));    // 10 minutes after

        statusDiv.textContent = 'Loading logs...';
        statusDiv.style.color = '#4fc1ff';
        loadBtn.disabled = true;

        try {
            const url = `/api/sessions/historical-logs?session_id={{.Session.SessionId}}&start=${Math.floor(start.getTime() / 1000)}&end=${Math.floor(end.getTime() / 1000)}`;
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }

            const data = await response.json();
            logOutput.textContent = '';

            if (!data.batches || data.batches.length === 0) {
                statusDiv.textContent = 'No logs found for this time range';
                statusDiv.style.color = '#888';
                logViewer.style.display = 'none';
                downloadBtn.style.display = 'none';
                currentLogData = null;
                return;
            }

            // Store data for download
            currentLogData = data;

            // Display batches in order
            for (const batch of data.batches) {
                const lines = batch.content.split('\n');
                for (const lineText of lines) {
                    parseAndAppendRawLine(logOutput, lineText);
                }
            }

            logViewer.style.display = 'block';
            downloadBtn.style.display = 'inline-block';
            statusDiv.textContent = `Loaded ${data.batches.length} log batch(es)`;
            statusDiv.style.color = '#4fc1ff';
        } catch (err) {
            statusDiv.textContent = `Error: ${err.message}`;
            statusDiv.style.color = '#f48771';
        } finally {
            loadBtn.disabled = false;
        }
    };

    downloadBtn.onclick = () => {
        if (!currentLogData || !currentLogData.batches) {
            return;
        }

        // Combine all batches into a single text file
        let combinedLogs = '';
        for (const batch of currentLogData.batches) {
            combinedLogs += batch.content;
        }

        // Create download link
        const blob = new Blob([combinedLogs], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        // Generate filename with center timestamp
        const centerDate = new Date(centerTimeInput.value);
        const filename = `session-{{.Session.SessionId}}-logs-${centerDate.toISOString().replace(/[:.]/g, '-')}.log`;
        a.download = filename;

        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    clearBtn.onclick = () => {
        logOutput.textContent = '';
        logViewer.style.display = 'none';
        downloadBtn.style.display = 'none';
        statusDiv.textContent = '';
        currentLogData = null;
    };

    // Auto-load logs on page load
    {{if .Session.EndedAt}}
    setTimeout(() => loadBtn.click(), 500);
    {{end}}
})();
</script>
{{end}}
{{end}}
